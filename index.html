<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>普通话活动室考勤系统</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8, #6c8ef5);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
        }
        
        .panel h2 {
            color: #1a73e8;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
            padding: 12px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #0d62d9;
        }
        
        button.secondary {
            background-color: #5f6368;
        }
        
        button.secondary:hover {
            background-color: #4a4d52;
        }
        
        .qr-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .qr-card {
            text-align: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f9f9f9;
            width: 130px;
        }
        
        .qr-card img {
            width: 100px;
            height: 100px;
            margin-bottom: 5px;
            image-rendering: crisp-edges;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin: 15px 0;
        }
        
        #video {
            width: 100%;
            border-radius: 5px;
            background: #000;
        }
        
        #scan-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background: #f0f7ff;
            border: 1px solid #c2e0ff;
        }
        
        .record-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }
        
        .record-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .session-selector {
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #e6f4ea;
            border: 1px solid #34a853;
            color: #137333;
        }
        
        .error {
            background-color: #fce8e6;
            border: 1px solid #ea4335;
            color: #c5221f;
        }
        
        .info {
            background-color: #e8f0fe;
            border: 1px solid #1a73e8;
            color: #174ea6;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #5f6368;
            font-size: 14px;
        }
        
        .class-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .class-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px;
            font-size: 14px;
            background-color: #e8e8e8;
            color: #333;
            border: 2px solid transparent;
        }
        
        .class-btn.active {
            background-color: #1a73e8;
            color: white;
            border-color: #0d62d9;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .class-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>普通话活动室考勤系统</h1>
        <p>预设班级QR码 - 直接扫描登记</p>
    </header>
    
    <div class="container">
        <div class="panel">
            <h2>1. 班级QR码管理</h2>
            <div class="form-group">
                <label for="grade-select">选择年级</label>
                <select id="grade-select">
                    <option value="P1">小一 (P1)</option>
                    <option value="P2">小二 (P2)</option>
                    <option value="P3">小三 (P3)</option>
                    <option value="P4">小四 (P4)</option>
                    <option value="P5">小五 (P5)</option>
                    <option value="P6">小六 (P6)</option>
                </select>
            </div>
            
            <div class="class-buttons">
                <button class="class-btn active" data-class="A">A班</button>
                <button class="class-btn" data-class="B">B班</button>
                <button class="class-btn" data-class="C">C班</button>
                <button class="class-btn" data-class="D">D班</button>
                <button class="class-btn" data-class="E">E班</button>
            </div>
            
            <button id="generate-all" class="secondary">生成所有班级QR码</button>
            <button id="download-class" class="secondary">下载当前班级QR码</button>
            
            <div id="qr-container" class="qr-container"></div>
        </div>
        
        <div class="panel">
            <h2>2. 登记考勤</h2>
            <div class="form-group">
                <label for="session-id">本次考勤识别码</label>
                <input type="text" id="session-id" placeholder="例如：2024-03-20-活动1">
            </div>
            <button id="start-scan">开始扫描</button>
            <button id="stop-scan" class="secondary hidden">停止扫描</button>
            <div id="video-container" class="video-container hidden">
                <video id="video" autoplay muted playsinline></video>
            </div>
            <div id="scan-result"></div>
            <div id="attendance-list" class="record-list"></div>
        </div>
        
        <div class="panel">
            <h2>3. 考勤记录</h2>
            <div class="form-group session-selector">
                <label for="session-select">选择活动</label>
                <select id="session-select">
                    <option value="">-- 选择活动 --</option>
                </select>
            </div>
            <div id="records-list" class="record-list"></div>
            <button id="export-excel" class="secondary">导出为Excel</button>
            <button id="clear-data" class="secondary">清除所有数据</button>
        </div>
    </div>
    
    <footer>
        <p>普通话活动室考勤系统 &copy; 2024 - 预设P1A-P6E所有班级</p>
    </footer>

    <script>
        // 存储考勤数据
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let currentSessionId = '';
        let scannedStudents = new Set();
        let currentClass = 'P1A'; // 默认班级
        let isScanning = false;
        let videoStream = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载已有的活动列表
            updateSessionSelect();
            
            // 班级选择事件
            document.getElementById('grade-select').addEventListener('change', updateCurrentClass);
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateCurrentClass(null, this.getAttribute('data-class'));
                });
            });
            
            // 生成所有QR码按钮事件
            document.getElementById('generate-all').addEventListener('click', generateAllQRCodes);
            
            // 下载班级QR码按钮事件
            document.getElementById('download-class').addEventListener('click', downloadClassQRCodes);
            
            // 开始扫描按钮事件
            document.getElementById('start-scan').addEventListener('click', startScanner);
            
            // 停止扫描按钮事件
            document.getElementById('stop-scan').addEventListener('click', stopScanner);
            
            // 导出Excel按钮事件
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            
            // 清除数据按钮事件
            document.getElementById('clear-data').addEventListener('click', clearAllData);
            
            // 活动选择变化事件
            document.getElementById('session-select').addEventListener('change', showSessionRecords);
            
            // 初始化显示P1A班的QR码
            generateClassQRCodes(currentClass);
        });
        
        // 更新当前班级
        function updateCurrentClass(event, cls = null) {
            const grade = document.getElementById('grade-select').value;
            const classLetter = cls || 'A';
            currentClass = grade + classLetter;
            
            // 更新按钮状态 - 修复视觉区分
            document.querySelectorAll('.class-btn').forEach(btn => {
                if (btn.getAttribute('data-class') === classLetter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // 生成该班级的QR码
            generateClassQRCodes(currentClass);
        }
        
        // 生成指定班级的QR码 - 使用qrcode-generator库
        function generateClassQRCodes(className) {
            const qrContainer = document.getElementById('qr-container');
            qrContainer.innerHTML = '';
            
            // 生成01-30号学生的QR码
            for (let i = 1; i <= 30; i++) {
                const studentId = `${className} ${i.toString().padStart(2, '0')}`;
                const qrCard = document.createElement('div');
                qrCard.className = 'qr-card';
                
                const img = document.createElement('img');
                img.alt = `QR Code for ${studentId}`;
                qrCard.appendChild(img);
                
                const label = document.createElement('div');
                label.textContent = studentId;
                qrCard.appendChild(label);
                
                qrContainer.appendChild(qrCard);
                
                // 生成QR码
                generateQRCode(img, studentId);
            }
            
            showStatus(`已生成 ${className} 班QR码`, 'success');
        }
        
        // 使用qrcode-generator库生成QR码
        function generateQRCode(imgElement, text) {
            try {
                // 使用qrcode-generator库
                const typeNumber = 4; // QR码类型
                const errorCorrectionLevel = 'L'; // 错误纠正级别
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(text);
                qr.make();
                
                // 生成QR码图片
                imgElement.src = qr.createDataURL(10, 0); // 10是单元格大小，0是边距
            } catch (error) {
                console.error('QR码生成错误:', error);
                // 备用方案：显示文本
                imgElement.style.display = 'none';
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                textDiv.style.fontSize = '10px';
                textDiv.style.wordBreak = 'break-all';
                imgElement.parentNode.appendChild(textDiv);
            }
        }
        
        // 生成所有班级的QR码
        function generateAllQRCodes() {
            const grades = ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'];
            const classes = ['A', 'B', 'C', 'D', 'E'];
            
            // 显示生成中状态
            showStatus('正在生成所有班级QR码，请稍候...', 'info');
            
            // 创建新窗口显示所有QR码
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>所有班级QR码</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .class-section { margin-bottom: 40px; page-break-after: always; }
                        .class-title { font-size: 24px; margin-bottom: 20px; }
                        .qr-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
                        .qr-item { text-align: center; border: 1px solid #ccc; padding: 10px; }
                        img { width: 100px; height: 100px; image-rendering: crisp-edges; }
                        @media print {
                            .class-section { page-break-after: always; }
                        }
                    </style>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"><\/script>
                </head>
                <body>
                    <h1>所有班级QR码</h1>
            `);
            
            let count = 0;
            
            // 为每个班级生成QR码
            grades.forEach(grade => {
                classes.forEach(cls => {
                    const className = grade + cls;
                    printWindow.document.write(`<div class="class-section"><h2 class="class-title">${className}班</h2><div class="qr-grid">`);
                    
                    // 生成01-30号学生的QR码
                    for (let i = 1; i <= 30; i++) {
                        const studentId = `${className} ${i.toString().padStart(2, '0')}`;
                        printWindow.document.write(`
                            <div class="qr-item">
                                <img id="${studentId.replace(' ', '_')}" alt="${studentId}" />
                                <div>${studentId}</div>
                            </div>
                        `);
                        count++;
                    }
                    
                    printWindow.document.write('</div></div>');
                });
            });
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // 在所有QR码生成后显示完成消息
            setTimeout(() => {
                grades.forEach(grade => {
                    classes.forEach(cls => {
                        const className = grade + cls;
                        for (let i = 1; i <= 30; i++) {
                            const studentId = `${className} ${i.toString().padStart(2, '0')}`;
                            const img = printWindow.document.getElementById(studentId.replace(' ', '_'));
                            if (img) {
                                // 使用qrcode-generator库生成QR码
                                try {
                                    const typeNumber = 4;
                                    const errorCorrectionLevel = 'L';
                                    const qr = qrcode(typeNumber, errorCorrectionLevel);
                                    qr.addData(studentId);
                                    qr.make();
                                    img.src = qr.createDataURL(10, 0);
                                } catch (error) {
                                    console.error('QR码生成错误:', error);
                                    img.style.display = 'none';
                                    const textDiv = printWindow.document.createElement('div');
                                    textDiv.textContent = studentId;
                                    textDiv.style.fontSize = '10px';
                                    textDiv.style.wordBreak = 'break-all';
                                    img.parentNode.appendChild(textDiv);
                                }
                            }
                        }
                    });
                });
                
                showStatus(`成功生成所有 ${count} 个学生QR码`, 'success');
                
                // 提示用户可以打印页面
                setTimeout(() => {
                    if (confirm('所有QR码已生成，是否打印页面？')) {
                        printWindow.print();
                    }
                }, 1000);
            }, 500);
        }
        
        // 下载当前班级QR码
        function downloadClassQRCodes() {
            const qrContainer = document.getElementById('qr-container');
            const qrCards = qrContainer.querySelectorAll('.qr-card');
            
            if (qrCards.length === 0) {
                showStatus('请先生成QR码', 'error');
                return;
            }
            
            showStatus('正在准备下载，请稍候...', 'info');
            
            // 创建下载链接
            const downloadContainer = document.createElement('div');
            downloadContainer.style.display = 'none';
            document.body.appendChild(downloadContainer);
            
            let downloaded = 0;
            const total = qrCards.length;
            
            qrCards.forEach(card => {
                const img = card.querySelector('img');
                const studentId = card.querySelector('div').textContent;
                
                if (img && img.src) {
                    const a = document.createElement('a');
                    a.href = img.src;
                    a.download = `${studentId}.png`;
                    downloadContainer.appendChild(a);
                    a.click();
                    downloaded++;
                } else {
                    downloaded++;
                }
                
                // 当所有图片都尝试下载后
                if (downloaded === total) {
                    document.body.removeChild(downloadContainer);
                    if (downloaded > 0) {
                        showStatus(`已开始下载 ${currentClass} 班QR码，请查看浏览器下载`, 'success');
                    } else {
                        showStatus('没有可下载的QR码', 'error');
                    }
                }
            });
        }
        
        // 开始扫描
        function startScanner() {
            currentSessionId = document.getElementById('session-id').value.trim();
            if (!currentSessionId) {
                showStatus('请输入本次考勤识别码', 'error');
                return;
            }
            
            // 初始化活动数据
            if (!attendanceData[currentSessionId]) {
                attendanceData[currentSessionId] = [];
            }
            
            scannedStudents.clear();
            updateAttendanceList();
            
            const video = document.getElementById('video');
            const videoContainer = document.getElementById('video-container');
            const scanResult = document.getElementById('scan-result');
            const startBtn = document.getElementById('start-scan');
            const stopBtn = document.getElementById('stop-scan');
            
            videoContainer.classList.remove('hidden');
            stopBtn.classList.remove('hidden');
            startBtn.classList.add('hidden');
            scanResult.innerHTML = '';
            
            isScanning = true;
            
            // 访问摄像头
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(function(stream) {
                videoStream = stream;
                video.srcObject = stream;
                video.play();
                scanLoop();
                showStatus('摄像头已启动，开始扫描QR码...', 'info');
            })
            .catch(function(err) {
                showStatus('无法访问摄像头: ' + err.message, 'error');
                stopScanner();
            });
        }
        
        // 扫描循环
        function scanLoop() {
            if (!isScanning) return;
            
            const video = document.getElementById('video');
            const scanResult = document.getElementById('scan-result');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    const studentId = code.data;
                    
                    // 验证学生ID格式 (P1A 01 到 P6E 30)
                    const pattern = /^(P[1-6][A-E]) (0[1-9]|[12][0-9]|30)$/;
                    if (!pattern.test(studentId)) {
                        scanResult.innerHTML = `<div class="status error">无效QR码: ${studentId}</div>`;
                        setTimeout(() => {
                            scanResult.innerHTML = '';
                        }, 2000);
                    } else if (!scannedStudents.has(studentId)) {
                        // 记录考勤
                        const timestamp = new Date().toLocaleString('zh-CN');
                        attendanceData[currentSessionId].push({
                            studentId: studentId,
                            timestamp: timestamp
                        });
                        
                        // 保存到本地存储
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                        
                        scannedStudents.add(studentId);
                        updateAttendanceList();
                        updateSessionSelect();
                        
                        scanResult.innerHTML = `<div class="status success">已登记: ${studentId} - ${timestamp}</div>`;
                        
                        // 短暂显示成功信息
                        setTimeout(() => {
                            scanResult.innerHTML = '';
                        }, 2000);
                    }
                }
            }
            
            if (isScanning) {
                requestAnimationFrame(scanLoop);
            }
        }
        
        // 停止扫描
        function stopScanner() {
            isScanning = false;
            
            const video = document.getElementById('video');
            const videoContainer = document.getElementById('video-container');
            const startBtn = document.getElementById('start-scan');
            const stopBtn = document.getElementById('stop-scan');
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            video.srcObject = null;
            videoContainer.classList.add('hidden');
            stopBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
            
            showStatus('扫描已停止', 'info');
        }
        
        // 更新考勤列表
        function updateAttendanceList() {
            const attendanceList = document.getElementById('attendance-list');
            attendanceList.innerHTML = '';
            
            if (attendanceData[currentSessionId] && attendanceData[currentSessionId].length > 0) {
                // 按时间排序
                const sortedRecords = [...attendanceData[currentSessionId]].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                sortedRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item';
                    item.innerHTML = `
                        <span>${record.studentId}</span>
                        <span>${record.timestamp}</span>
                    `;
                    attendanceList.appendChild(item);
                });
            } else {
                attendanceList.innerHTML = '<div class="status info">暂无考勤记录</div>';
            }
        }
        
        // 更新活动选择下拉框
        function updateSessionSelect() {
            const sessionSelect = document.getElementById('session-select');
            sessionSelect.innerHTML = '<option value="">-- 选择活动 --</option>';
            
            Object.keys(attendanceData).forEach(sessionId => {
                const option = document.createElement('option');
                option.value = sessionId;
                option.textContent = sessionId;
                sessionSelect.appendChild(option);
            });
        }
        
        // 显示活动记录
        function showSessionRecords() {
            const sessionId = document.getElementById('session-select').value;
            const recordsList = document.getElementById('records-list');
            recordsList.innerHTML = '';
            
            if (sessionId && attendanceData[sessionId]) {
                // 按时间排序
                const sortedRecords = [...attendanceData[sessionId]].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                sortedRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-item';
                    item.innerHTML = `
                        <span>${record.studentId}</span>
                        <span>${record.timestamp}</span>
                    `;
                    recordsList.appendChild(item);
                });
                
                // 显示统计信息
                const count = document.createElement('div');
                count.className = 'status info';
                count.textContent = `共 ${sortedRecords.length} 条记录`;
                recordsList.appendChild(count);
            } else {
                recordsList.innerHTML = '<div class="status info">请选择活动或该活动暂无记录</div>';
            }
        }
        
        // 导出为Excel
        function exportToExcel() {
            if (Object.keys(attendanceData).length === 0) {
                showStatus('暂无考勤记录可导出', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // 为每个活动创建一个工作表
            Object.keys(attendanceData).forEach(sessionId => {
                const records = attendanceData[sessionId];
                const wsData = [
                    ['学号', '时间']  // 表头
                ];
                
                // 按时间排序
                const sortedRecords = [...records].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                sortedRecords.forEach(record => {
                    wsData.push([record.studentId, record.timestamp]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, sessionId.substring(0, 31)); // Excel工作表名最多31字符
            });
            
            // 生成并下载Excel文件
            XLSX.writeFile(wb, '考勤记录.xlsx');
            showStatus('Excel文件已生成并开始下载', 'success');
        }
        
        // 清除所有数据
        function clearAllData() {
            if (confirm('确定要清除所有考勤数据吗？此操作不可恢复！')) {
                attendanceData = {};
                localStorage.removeItem('attendanceData');
                updateSessionSelect();
                document.getElementById('records-list').innerHTML = '<div class="status info">数据已清除</div>';
                showStatus('所有数据已清除', 'success');
            }
        }
        
        // 显示状态信息
        function showStatus(message, type) {
            // 移除现有的状态信息
            const existingStatus = document.querySelector('.status');
            if (existingStatus && existingStatus.parentNode === document.body) {
                existingStatus.remove();
            }
            
            // 创建新的状态信息
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            
            // 插入到页面顶部
            document.body.insertBefore(status, document.querySelector('header'));
            
            // 5秒后自动移除
            setTimeout(() => {
                if (status.parentNode) {
                    status.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>